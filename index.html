<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EC660C Plate Maker</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.6.0/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        form label,
        form select,
        form button {
            display: block;
            margin-bottom: 10px;
        }

        select,
        button {
            min-width: 100%;
            height: 40px;
        }

        @media (max-width: 600px) {
            body {
                font-size: 18px;
            }

            button {
                padding: 15px 30px;
                margin-top: 25px;
            }
        }

        button {
            margin-top: 25px;
        }

        footer {
            margin-top: 50px;
        }
    </style>
</head>

<body>
    <h1>EC660C Plate Maker</h1>
    <p>This plate maker is specifically for the EC660C PCB and its own screw hole placement.</p>
    <form id="configForm">
        <label for="backspace">Backspace:</label>
        <select id="backspace">
            <option value="" selected disabled hidden>Choose here</option>
            <option value="0">Unified Backspace</option>
            <option value="1">Split Backspace</option>
        </select>
        <label for="left_shift">Left Shift:</label>
        <select id="left_shift">
            <option value="" selected disabled hidden>Choose here</option>
            <option value="0">Unified Left Shift</option>
            <option value="1">Split Left Shift</option>
        </select>
        <label for="enter">Enter:</label>
        <select id="enter">
            <option value="" selected disabled hidden>Choose here</option>
            <option value="0">ANSI</option>
            <option value="1">ISO</option>
        </select>
        <label for="bottom_row">Bottom Row:</label>
        <select id="bottom_row">
            <option value="" selected disabled hidden>Choose here</option>
            <option value="0">OEM 6U</option>
            <option value="1">7U WK</option>
            <option value="2">7U WKL</option>
            <option value="3">6U</option>
        </select>
        <label for="isolated_keys">Isolated Keys:</label>
        <select id="isolated_keys">
            <option value="" selected disabled hidden>Choose here</option>
            <option value="0">Split Keys</option>
            <option value="1">Vertical 2U</option>
        </select>
        <label for="hole_type">Hole Type:</label>
        <select id="hole_type">
            <option value="" selected disabled hidden>Choose here</option>
            <option value="Tapped_Holes">Tapped Holes</option>
            <option value="Densus_Inserts">Densus Inserts</option>
        </select>
        <button type="submit">Download</button>
    </form>

    <footer>
        <p>&copy; 2024 Cipulot</p>
        <p>All files are provided under the <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/"
                target="_blank">CC BY-NC-SA 4.0</a> License.</p>
        <a href="https://cipulot.squarespace.com/" target="_blank">
            <img src="https://squarespace.com/favicon.ico" alt="Visit my Squarespace" />
        </a>
    </footer>

    <script>
        $(document).ready(function () {
            $("#configForm").submit(function (e) {
                e.preventDefault();
                var isFormFilled = true;
                $('select').each(function () {
                    if ($(this).val() == null) {
                        isFormFilled = false;
                        return false;
                    }
                });
                if (!isFormFilled) {
                    alert("Please select all configurations.");
                } else {
                    var configIndices = $('select').not('#hole_type').map(function () { return $(this).val(); }).get();
                    var filename = "EC660C_" + configIndices.join('_');
                    var holeType = $("#hole_type").val();

                    if (holeType === "Densus_Inserts") {
                        filename += "_Densus_Inserts";
                    }

                    filename += ".dxf";

                    var fileUrl = 'https://api.github.com/repos/Cipulot/ec660c-plate-maker/contents/Plate_Indexed_Name/' + filename;
                    var licenseUrl = 'https://api.github.com/repos/Cipulot/ec660c-plate-maker/contents/LICENSE';

                    fetch(fileUrl)
                        .then(response => response.json())
                        .then(data => {
                            if (data.encoding === 'base64') {
                                var base64String = data.content.replace(/\n/g, '');
                                var binaryString = atob(base64String);
                                var byteArray = new Uint8Array(binaryString.length);
                                for (var i = 0; i < binaryString.length; i++) {
                                    byteArray[i] = binaryString.charCodeAt(i);
                                }

                                var zip = new JSZip();
                                zip.file(filename, byteArray);

                                fetch(licenseUrl)
                                    .then(response => response.json())
                                    .then(licenseData => {
                                        if (licenseData.encoding === 'base64') {
                                            var licenseBase64 = licenseData.content.replace(/\n/g, '');
                                            var licenseBinary = atob(licenseBase64);
                                            var licenseByteArray = new Uint8Array(licenseBinary.length);
                                            for (var i = 0; i < licenseBinary.length; i++) {
                                                licenseByteArray[i] = licenseBinary.charCodeAt(i);
                                            }
                                            zip.file("LICENSE", licenseByteArray);

                                            if (holeType === "Densus_Inserts") {
                                                var densusGuideUrl = 'https://api.github.com/repos/Cipulot/ec660c-plate-maker/contents/densus_ec_insert_design_guide.png';
                                                fetch(densusGuideUrl)
                                                    .then(response => response.json())
                                                    .then(densusData => {
                                                        if (densusData.encoding === 'base64') {
                                                            var densusBase64 = densusData.content.replace(/\n/g, '');
                                                            var densusBinary = atob(densusBase64);
                                                            var densusByteArray = new Uint8Array(densusBinary.length);
                                                            for (var i = 0; i < densusBinary.length; i++) {
                                                                densusByteArray[i] = densusBinary.charCodeAt(i);
                                                            }
                                                            zip.file("densus_ec_insert_design_guide.png", densusByteArray);

                                                            zip.generateAsync({ type: "blob" }).then(function (content) {
                                                                saveAs(content, "EC660C_" + configIndices.join('_') + "_Densus_Inserts.zip");
                                                            });
                                                        } else {
                                                            throw new Error('Densus guide content is not base64 encoded');
                                                        }
                                                    })
                                                    .catch(error => {
                                                        console.error('Error fetching Densus guide:', error);
                                                    });
                                            } else {
                                                zip.generateAsync({ type: "blob" }).then(function (content) {
                                                    saveAs(content, "EC660C_" + configIndices.join('_') + ".zip");
                                                });
                                            }
                                        } else {
                                            throw new Error('License content is not base64 encoded');
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error fetching license:', error);
                                    });
                            } else {
                                throw new Error('DXF file content is not base64 encoded');
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching DXF file:', error);
                        });
                }
            });
        });
    </script>
</body>

</html>